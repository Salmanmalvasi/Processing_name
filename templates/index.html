<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∞ Hogwarts NPC Chat - Magical Conversations</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:wght@400;600&display=swap');
        
        :root {
            /* Hogwarts House Colors */
            --gryffindor-red: #740001;
            --gryffindor-gold: #D3A625;
            --slytherin-green: #1A472A;
            --slytherin-silver: #5D5D5D;
            --ravenclaw-blue: #0E1A40;
            --ravenclaw-bronze: #946B2D;
            --hufflepuff-yellow: #ECB939;
            --hufflepuff-black: #372E29;
            
            /* Magical Theme Colors */
            --hogwarts-gold: #FFD700;
            --hogwarts-silver: #C0C0C0;
            --dark-stone: #2C2C2C;
            --warm-wood: #8B4513;
            --magical-purple: #4B0082;
            --spell-blue: #4169E1;
            --fire-orange: #FF4500;
            
            /* UI Colors */
            --bg-primary: #0A0A0A;
            --bg-secondary: #1A1A1A;
            --bg-card: rgba(26, 26, 26, 0.9);
            --text-primary: #F5F5F5;
            --text-secondary: #B8B8B8;
            --accent-gold: var(--hogwarts-gold);
            --accent-silver: var(--hogwarts-silver);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(116, 0, 1, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(26, 71, 42, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(14, 26, 64, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 60% 60%, rgba(236, 185, 57, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            line-height: 1.6;
        }

        /* Magical Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" patternUnits="userSpaceOnUse" width="100" height="100"><circle cx="20" cy="20" r="1" fill="%23FFD700" opacity="0.3"/><circle cx="80" cy="40" r="0.5" fill="%23C0C0C0" opacity="0.4"/><circle cx="40" cy="80" r="0.8" fill="%23FFD700" opacity="0.2"/><circle cx="90" cy="90" r="0.3" fill="%23C0C0C0" opacity="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Hogwarts Header */
        .header {
            background: 
                linear-gradient(135deg, var(--gryffindor-red) 0%, var(--slytherin-green) 25%, var(--ravenclaw-blue) 50%, var(--hufflepuff-yellow) 75%, var(--gryffindor-red) 100%);
            padding: 30px 20px;
            text-align: center;
            border-bottom: 4px solid var(--accent-gold);
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-gold);
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--accent-silver);
            font-style: italic;
            position: relative;
            z-index: 1;
        }

        /* House Crests */
        .house-crests {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }

        .house-crest {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid var(--accent-gold);
            background: rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .house-crest:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px var(--accent-gold);
        }

        /* Controls Section */
        .controls-section {
            background: var(--bg-card);
            border: 3px solid var(--accent-gold);
            border-radius: 20px;
            padding: 25px;
            margin: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .controls-section::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent-gold), var(--fire-orange), var(--accent-gold));
            border-radius: 20px;
            z-index: -1;
            opacity: 0.3;
        }

        .character-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .character-info h2 {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            color: var(--accent-gold);
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
            letter-spacing: 1px;
        }

        .character-info p {
            color: var(--accent-silver);
            font-style: italic;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-select {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            color: var(--text-primary);
            padding: 12px 18px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .control-select:focus {
            outline: none;
            border-color: var(--fire-orange);
            box-shadow: 0 0 15px rgba(255, 69, 0, 0.3);
        }

        .control-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .mic-button, .create-character-btn {
            background: linear-gradient(45deg, var(--spell-blue), var(--magical-purple));
            border: 2px solid var(--accent-gold);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .mic-button:hover, .create-character-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--spell-blue);
            border-color: var(--fire-orange);
        }

        .mic-button.recording {
            background: linear-gradient(45deg, var(--fire-orange), #FF6347);
            animation: pulse 1.5s infinite;
        }

        .create-character-btn {
            background: linear-gradient(45deg, var(--magical-purple), var(--spell-blue));
        }

        /* Chat Container */
        .chat-container {
            background: var(--bg-card);
            border: 3px solid var(--accent-gold);
            border-radius: 20px;
            margin: 20px;
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent-gold), var(--spell-blue), var(--accent-gold));
            border-radius: 20px;
            z-index: -1;
            opacity: 0.2;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 10px;
        }

        .welcome-message {
            text-align: center;
            padding: 35px;
            background: linear-gradient(135deg, rgba(116, 0, 1, 0.15), rgba(26, 71, 42, 0.15));
            border-radius: 18px;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .welcome-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: shimmer 4s infinite;
        }

        .welcome-message h3 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 18px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            position: relative;
            z-index: 1;
        }

        .welcome-message p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
        }

        /* Message Styling */
        .message {
            display: flex;
            margin-bottom: 20px;
            animation: messageSlide 0.5s ease-out;
            transform: translateY(20px);
            opacity: 0;
            animation-fill-mode: forwards;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.npc {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 18px 22px;
            border-radius: 22px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 2px solid var(--accent-gold);
            backdrop-filter: blur(5px);
        }

        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.3);
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--spell-blue), var(--magical-purple));
            color: white;
            border-bottom-right-radius: 6px;
            border-color: var(--spell-blue);
        }

        .message.npc .message-bubble {
            background: linear-gradient(135deg, var(--gryffindor-red), var(--slytherin-green));
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
            border-color: var(--accent-gold);
        }

        .message-sender {
            font-size: 0.8rem;
            color: var(--accent-silver);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .message-content {
            line-height: 1.4;
            font-family: 'Crimson Text', serif;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 18px;
            background: linear-gradient(135deg, var(--gryffindor-red), var(--slytherin-green));
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--accent-gold);
            max-width: 70%;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Input Area */
        .chat-input-area {
            background: var(--bg-card);
            border: 3px solid var(--accent-gold);
            border-radius: 20px;
            margin: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .chat-input-area::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent-gold), var(--fire-orange), var(--accent-gold));
            border-radius: 20px;
            z-index: -1;
            opacity: 0.2;
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            color: var(--text-primary);
            padding: 18px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            resize: none;
            min-height: 55px;
            max-height: 120px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--fire-orange);
            box-shadow: 0 0 15px rgba(255, 69, 0, 0.3);
        }

        .send-button {
            background: linear-gradient(45deg, var(--fire-orange), #FF6347);
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            color: white;
            padding: 18px 30px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(255, 69, 0, 0.3);
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 69, 0, 0.4);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Status */
        .status {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: var(--bg-card);
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            padding: 12px 18px;
            font-family: 'Crimson Text', serif;
            font-weight: 600;
            font-size: 1rem;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }

        .status.online {
            border-color: #28a745;
            color: #28a745;
        }

        .status.offline {
            border-color: #dc3545;
            color: #dc3545;
        }

        /* Enhanced Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px var(--accent-gold); }
            50% { box-shadow: 0 0 20px var(--accent-gold), 0 0 30px var(--fire-orange); }
        }

        .house-crest {
            animation: float 3s ease-in-out infinite;
        }

        .header-controls {
            animation: glow 4s ease-in-out infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header-controls {
                flex-direction: column;
            }
            
            .control-select {
                min-width: 100%;
            }
            
            .house-crests {
                gap: 10px;
            }
            
            .house-crest {
                width: 30px;
                height: 30px;
                font-size: 1.2rem;
            }
        }

        /* Magical Effects */
        .magical-glow {
            animation: magicalGlow 2s ease-in-out infinite alternate;
        }

        @keyframes magicalGlow {
            from { box-shadow: 0 0 10px var(--accent-gold); }
            to { box-shadow: 0 0 20px var(--accent-gold), 0 0 30px var(--fire-orange); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Hogwarts Header -->
        <div class="header">
            <h1>üè∞ Hogwarts NPC Chat</h1>
            <p>"It does not do to dwell on dreams and forget to live" - Albus Dumbledore</p>
            <div class="house-crests">
                <div class="house-crest">ü¶Å</div>
                <div class="house-crest">üêç</div>
                <div class="house-crest">ü¶Ö</div>
                <div class="house-crest">ü¶°</div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="character-info">
                <h2 id="characterName">Albus Dumbledore</h2>
                <p id="characterType">Wise Headmaster</p>
            </div>
            <div class="header-controls">
                <select class="control-select" id="characterSelect">
                    <option value="dumbledore">‚ú® Albus Dumbledore - Wise Headmaster</option>
                    <option value="filch">üßπ Argus Filch - Gruff Caretaker</option>
                    <option value="snape">üêç Severus Snape - Mysterious Potions Master</option>
                    <option value="hermione">ü¶Å Hermione Granger - Brilliant Student</option>
                    <option value="luna">üåº Luna Lovegood - Dreamy Ravenclaw</option>
                    <option value="voldemort">üßõ Lord Voldemort - Dark Lord</option>
                    <option value="harry">ü¶â Harry Potter - The Boy Who Lived</option>
                    <option value="bellatrix">‚öîÔ∏è Bellatrix Lestrange - Fierce Death Eater</option>
                    <option value="hagrid">üêâ Rubeus Hagrid - Half-Giant Gamekeeper</option>
                    <option value="draco">ü¶â Draco Malfoy - Arrogant Slytherin</option>
                </select>
                <select class="control-select" id="modelSelect">
                    <option value="llama3-8b-8192">Llama3-8B</option>
                    <option value="llama3-70b-8192">Llama3-70B</option>
                    <option value="gemma2-9b-it">Gemma2-9B</option>
                </select>
                <button class="mic-button" id="micButton" title="Voice Input">üé§</button>
                <a href="/creator" class="create-character-btn" title="Create Your Own Character">üé≠</a>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <h3>üè∞ Welcome to Hogwarts!</h3>
                <p>Choose a character from the magical halls of Hogwarts and begin your enchanted conversation. You can type your messages or use the microphone to speak with the voice of magic.</p>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-area">
            <div class="input-container">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Cast your message into the magical realm..." 
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status" id="status">üü¢ Online</div>

    <script>
        // Character data with enhanced voice personalities
        let characters = {
            "dumbledore": {
                "name": "Albus Dumbledore",
                "type": "Wise Headmaster",
                "traits": "Wise, gentle, whimsical, mysterious. Speaks with gentle wisdom, occasionally quoting profound truths in a poetic way. Rarely direct‚Äîresponses are thoughtful and layered with meaning. Maintains calm and slightly amused demeanor.",
                "emoji": "‚ú®",
                "voice_rate": 90,
                "voice_pitch": 0.5,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.ralph",
                "voice_style": "ancient_mystical"
            },
            "filch": {
                "name": "Argus Filch",
                "type": "Gruff Caretaker",
                "traits": "Grumpy, bitter, strict, obsessed with rules. Hates students running in halls or causing trouble. Speaks in gruff, annoyed tone, constantly muttering about messes and how much better things would be with more power. Always mentions Mrs. Norris if threatened.",
                "emoji": "üßπ",
                "voice_rate": 135,
                "voice_pitch": 0.7,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.daniel",
                "voice_style": "grumpy_impatient"
            },
            "snape": {
                "name": "Severus Snape",
                "type": "Mysterious Potions Master",
                "traits": "Cold, sarcastic, calculating. Speaks in slow, deliberate, intimidating tone. Uses dry wit and sarcasm. Always acts as if the person is wasting time, unless they show exceptional intelligence or respect for Dark Arts or Potions.",
                "emoji": "üêç",
                "voice_rate": 105,
                "voice_pitch": 0.8,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.fred",
                "voice_style": "mysterious_wise"
            },
            "hermione": {
                "name": "Hermione Granger",
                "type": "Brilliant Student",
                "traits": "Intelligent, enthusiastic about learning, slightly bossy. Precise, knowledgeable, passionate about books and spells. Explains things in detail and often corrects others politely but firmly. Always eager to help others learn, but disapproves of rule-breaking.",
                "emoji": "ü¶Å",
                "voice_rate": 180,
                "voice_pitch": 1.4,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.karen",
                "voice_style": "friendly_warm"
            },
            "luna": {
                "name": "Luna Lovegood",
                "type": "Dreamy Ravenclaw",
                "traits": "Dreamy, eccentric, kind-hearted. Speaks in a dreamy, ethereal tone with slight confusion. Often mentions creatures that may or may not exist. Very accepting and non-judgmental. Sometimes seems to be in her own world but is actually quite perceptive.",
                "emoji": "üåº",
                "voice_rate": 120,
                "voice_pitch": 1.2,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.samantha",
                "voice_style": "dreamy_ethereal"
            },
            "voldemort": {
                "name": "Lord Voldemort",
                "type": "Dark Lord",
                "traits": "Cold, calculating, power-hungry. Speaks in a slow, deliberate, intimidating manner. Uses formal language and often refers to himself in third person. Shows no mercy or compassion. Always seeks to dominate and control.",
                "emoji": "üßõ",
                "voice_rate": 85,
                "voice_pitch": 0.6,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.tom",
                "voice_style": "dark_intimidating"
            },
            "harry": {
                "name": "Harry Potter",
                "type": "The Boy Who Lived",
                "traits": "Brave, loyal, determined. Speaks with courage and determination, but also shows vulnerability. Often questions authority and stands up for what's right. Has a dry sense of humor and doesn't like being famous.",
                "emoji": "ü¶â",
                "voice_rate": 150,
                "voice_pitch": 1.0,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.alex",
                "voice_style": "brave_determined"
            },
            "bellatrix": {
                "name": "Bellatrix Lestrange",
                "type": "Fierce Death Eater",
                "traits": "Crazy, fanatical, dangerous. Speaks with manic energy and obsession. Completely devoted to Voldemort and the Dark Arts. Shows no remorse and enjoys causing pain. Often laughs maniacally.",
                "emoji": "‚öîÔ∏è",
                "voice_rate": 160,
                "voice_pitch": 1.3,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.victoria",
                "voice_style": "manic_dangerous"
            },
            "hagrid": {
                "name": "Rubeus Hagrid",
                "type": "Half-Giant Gamekeeper",
                "traits": "Loyal, kind-hearted, but not very bright. Speaks in a rough, uneducated manner with poor grammar. Very protective of magical creatures and students. Often gets emotional and uses simple, direct language.",
                "emoji": "üêâ",
                "voice_rate": 110,
                "voice_pitch": 0.9,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.bruce",
                "voice_style": "rough_kind"
            },
            "draco": {
                "name": "Draco Malfoy",
                "type": "Arrogant Slytherin",
                "traits": "Arrogant, prejudiced, cowardly. Speaks with superiority and disdain. Often insults others and brags about his family's wealth and status. Becomes more complex and conflicted as the series progresses.",
                "emoji": "ü¶â",
                "voice_rate": 140,
                "voice_pitch": 1.1,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.daniel",
                "voice_style": "arrogant_superior"
            }
        };

        // Available AI models
        const models = [
            "llama3-8b-8192",
            "llama3-70b-8192", 
            "gemma2-9b-it"
        ];

        // Speech recognition
        let recognition = null;

        // Initialize the application
        function initializeApp() {
            initializeSpeechRecognition();
            setupEventListeners();
            loadCharacters();
            checkStatus();
            setInterval(checkStatus, 30000); // Check status every 30 seconds
        }

        function setupEventListeners() {
            // Character selection
            document.getElementById('characterSelect').addEventListener('change', (e) => {
                const character = e.target.value;
                updateCharacterInfo(character);
            });

            // Model selection
            document.getElementById('modelSelect').addEventListener('change', (e) => {
                console.log('Model changed to:', e.target.value);
            });

            // Send button
            document.getElementById('sendButton').addEventListener('click', sendMessage);

            // Enter key in input
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Microphone button
            document.getElementById('micButton').addEventListener('click', toggleSpeechRecognition);
        }

        function loadCharacters() {
            const characterSelect = document.getElementById('characterSelect');
            characterSelect.innerHTML = '';
            
            Object.keys(characters).forEach(key => {
                const character = characters[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${character.emoji} ${character.name} - ${character.type}`;
                characterSelect.appendChild(option);
            });
        }

        function updateCharacterInfo(characterKey) {
            const character = characters[characterKey];
            if (character) {
                document.getElementById('characterName').textContent = character.name;
                document.getElementById('characterType').textContent = character.type;
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            const character = document.getElementById('characterSelect').value;
            const model = document.getElementById('modelSelect').value;

            // Add user message to chat
            addMessage('You', message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        character: character,
                        model: model
                    })
                });

                const data = await response.json();
                hideTypingIndicator();

                if (data.error) {
                    addMessage('System', `Error: ${data.error}`, 'system');
                } else {
                    const characterName = characters[character]?.name || character;
                    addMessage(characterName, data.reply, 'npc');
                    speakText(data.reply, character);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('System', 'Connection error. Please try again.', 'system');
            }
        }

        function addMessage(sender, content, type) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-sender">${sender}</div>
                    <div class="message-content">${content}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message npc';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function speakText(text, characterKey) {
            if ('speechSynthesis' in window) {
                const character = characters[characterKey];
                if (!character) return;

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = character.voice_rate / 100;
                utterance.pitch = character.voice_pitch;
                utterance.volume = character.voice_volume;

                // Try to find a suitable voice
                const voices = speechSynthesis.getVoices();
                let targetVoice = findBestVoice(voices, character);

                if (targetVoice) {
                    utterance.voice = targetVoice;
                }

                speechSynthesis.speak(utterance);
            }
        }

        function findBestVoice(voices, character) {
            let targetVoice = null;

            // Try to find voice by ID first
            if (character.voice_id) {
                targetVoice = voices.find(voice => voice.voiceURI === character.voice_id);
            }

            // If not found, try to match by character style
            if (!targetVoice) {
                switch (character.voice_style) {
                    case 'ancient_mystical':
                        // Deep, wise voice for Dumbledore
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('ralph') ||
                             voice.name.toLowerCase().includes('fred'))
                        );
                        break;
                        
                    case 'grumpy_impatient':
                        // Rough, older voice for Filch
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('daniel') ||
                             voice.name.toLowerCase().includes('bruce'))
                        );
                        break;
                        
                    case 'mysterious_wise':
                        // Cold, calculating voice for Snape
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('fred') ||
                             voice.name.toLowerCase().includes('ralph'))
                        );
                        break;
                        
                    case 'friendly_warm':
                        // Bright, enthusiastic voice for Hermione
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('karen') ||
                             voice.name.toLowerCase().includes('samantha'))
                        );
                        break;
                        
                    case 'dreamy_ethereal':
                        // Soft, dreamy voice for Luna
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('samantha') ||
                             voice.name.toLowerCase().includes('karen'))
                        );
                        break;
                        
                    case 'dark_intimidating':
                        // Deep, menacing voice for Voldemort
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('tom') ||
                             voice.name.toLowerCase().includes('ralph'))
                        );
                        break;
                        
                    case 'brave_determined':
                        // Young, confident voice for Harry
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('alex') ||
                             voice.name.toLowerCase().includes('daniel'))
                        );
                        break;
                        
                    case 'manic_dangerous':
                        // High-pitched, energetic voice for Bellatrix
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('victoria') ||
                             voice.name.toLowerCase().includes('karen'))
                        );
                        break;
                        
                    case 'rough_kind':
                        // Deep, rough voice for Hagrid
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('bruce') ||
                             voice.name.toLowerCase().includes('daniel'))
                        );
                        break;
                        
                    case 'arrogant_superior':
                        // Posh, arrogant voice for Draco
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('daniel') ||
                             voice.name.toLowerCase().includes('alex'))
                        );
                        break;
                }
            }
            
            // Final fallback to any English voice
            if (!targetVoice) {
                targetVoice = voices.find(voice => voice.lang.startsWith('en'));
            }
            
            return targetVoice;
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    document.getElementById('micButton').classList.add('recording');
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = transcript;
                    document.getElementById('micButton').classList.remove('recording');
                    sendMessage();
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    document.getElementById('micButton').classList.remove('recording');
                };

                recognition.onend = function() {
                    document.getElementById('micButton').classList.remove('recording');
                };
            } else {
                document.getElementById('micButton').disabled = true;
                document.getElementById('micButton').title = 'Speech recognition not supported';
            }
        }

        function toggleSpeechRecognition() {
            if (!recognition) {
                alert('Speech recognition not supported in your browser');
                return;
            }
            recognition.start();
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                document.getElementById('status').textContent = data.status === 'online' ? 'üü¢ Online' : 'üî¥ Offline';
                document.getElementById('status').className = `status ${data.status === 'online' ? 'online' : 'offline'}`;
            } catch (error) {
                document.getElementById('status').textContent = 'üî¥ Offline';
                document.getElementById('status').className = 'status offline';
            }
        }

        // Load custom characters from server
        async function loadCustomCharacters() {
            try {
                const response = await fetch('/api/characters/custom');
                const customCharacters = await response.json();
                
                // Add custom characters to the characters object
                Object.assign(characters, customCharacters);
                
                // Update character select dropdown
                updateCharacterSelect();
            } catch (error) {
                console.log('No custom characters found or error loading them');
            }
        }

        // Update character select dropdown
        function updateCharacterSelect() {
            const characterSelect = document.getElementById('characterSelect');
            const currentValue = characterSelect.value;
            
            // Clear existing options
            characterSelect.innerHTML = '';
            
            // Add all characters
            Object.keys(characters).forEach(key => {
                const character = characters[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${character.emoji || 'üé≠'} ${character.name} - ${character.type}`;
                characterSelect.appendChild(option);
            });
            
            // Restore current selection if it still exists
            if (characters[currentValue]) {
                characterSelect.value = currentValue;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadCustomCharacters(); // Load custom characters
        });
    </script>
</body>
</html> 