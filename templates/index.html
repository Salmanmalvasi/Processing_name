<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∞ Harry Potter NPC Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-orange: #ff6b35;
            --secondary-orange: #ff8c42;
            --dark-bg: #0a0a0a;
            --darker-bg: #050505;
            --card-bg: rgba(20, 20, 20, 0.9);
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --glow-orange: 0 0 20px rgba(255, 107, 53, 0.5);
            --user-bubble: #667eea;
            --npc-bubble: #2d3748;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a1a1a 50%, var(--darker-bg) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="0.8" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="90" r="0.3" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .chat-header {
            background: var(--card-bg);
            border-radius: 20px 20px 0 0;
            padding: 20px 30px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-orange), var(--secondary-orange));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--glow-orange);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .character-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.6);
        }

        .character-avatar.changing {
            animation: characterSwitch 0.5s ease-in-out;
        }

        @keyframes characterSwitch {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(0.8) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        .character-info h2 {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            color: var(--primary-orange);
            margin-bottom: 5px;
        }

        .character-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-select {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 107, 53, 0.3);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .control-select:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: var(--glow-orange);
            transform: translateY(-1px);
        }

        .control-select:hover {
            border-color: var(--secondary-orange);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2);
        }

        .mic-button {
            padding: 10px 12px;
            background: linear-gradient(45deg, #10b981, #059669);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .mic-button.recording {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            animation: pulse 1.5s infinite;
        }

        /* Chat Area */
        .chat-container {
            background: var(--card-bg);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-top: none;
            border-bottom: none;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 10px;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: messageSlide 0.5s ease-out;
            transform: translateY(20px);
            opacity: 0;
            animation-fill-mode: forwards;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.npc {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--user-bubble), #5a67d8);
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .message.npc .message-bubble {
            background: linear-gradient(135deg, var(--npc-bubble), #4a5568);
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            box-shadow: 0 4px 15px rgba(45, 55, 72, 0.3);
        }

        .message-sender {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .message-content {
            line-height: 1.4;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 12px 18px;
            background: var(--npc-bubble);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            max-width: 70%;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary-orange);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Input Area */
        .chat-input-area {
            background: var(--card-bg);
            border-radius: 0 0 20px 20px;
            padding: 20px 30px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-top: none;
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 107, 53, 0.3);
            border-radius: 30px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: var(--glow-orange), 0 6px 20px rgba(255, 107, 53, 0.2);
            transform: translateY(-2px);
        }

        .message-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(45deg, var(--primary-orange), var(--secondary-orange));
            border: none;
            border-radius: 30px;
            color: white;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--glow-orange);
            min-width: 100px;
            position: relative;
            overflow: hidden;
        }

        .send-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .send-button:hover::before {
            left: 100%;
        }

        .send-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.4);
        }

        .send-button:active {
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .welcome-message h3 {
            font-family: 'Orbitron', monospace;
            color: var(--primary-orange);
            margin-bottom: 10px;
        }

        /* Status */
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 100;
        }

        .status.online {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .status.offline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .chat-header {
                padding: 15px 20px;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .control-select {
                font-size: 0.8rem;
                padding: 6px 8px;
            }
            
            .message-bubble {
                max-width: 85%;
            }
            
            .chat-input-area {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="header-left">
                <div class="character-avatar" id="characterAvatar">‚ú®</div>
                <div class="character-info">
                    <h2 id="characterName">Albus Dumbledore</h2>
                    <p id="characterType">Wise Headmaster</p>
                </div>
            </div>
            <div class="header-controls">
                                    <select class="control-select" id="characterSelect">
                        <option value="dumbledore">‚ú® Albus Dumbledore - Wise Headmaster</option>
                        <option value="filch">üßπ Argus Filch - Gruff Caretaker</option>
                        <option value="snape">üêç Severus Snape - Mysterious Potions Master</option>
                        <option value="hermione">ü¶Å Hermione Granger - Brilliant Student</option>
                        <option value="luna">üåº Luna Lovegood - Dreamy Ravenclaw</option>
                        <option value="voldemort">üßõ Lord Voldemort - Dark Lord</option>
                        <option value="harry">ü¶â Harry Potter - The Boy Who Lived</option>
                        <option value="bellatrix">‚öîÔ∏è Bellatrix Lestrange - Fierce Death Eater</option>
                        <option value="hagrid">üêâ Rubeus Hagrid - Half-Giant Gamekeeper</option>
                        <option value="draco">ü¶â Draco Malfoy - Arrogant Slytherin</option>
                    </select>
                <select class="control-select" id="modelSelect">
                    <option value="llama3-8b-8192">Llama3-8B</option>
                    <option value="llama3-70b-8192">Llama3-70B</option>
                    <option value="gemma2-9b-it">Gemma2-9B</option>
                </select>
                <button class="mic-button" id="micButton" title="Voice Input">üé§</button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <h3>üè∞ Welcome to Harry Potter NPC Chat!</h3>
                <p>Choose a character from Hogwarts and start chatting. You can type or use the microphone to speak.</p>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-area">
            <div class="input-container">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Type your message here..." 
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status" id="status">üü¢ Online</div>

    <script>
        // Character data with enhanced voice personalities
        const characters = {
            "dumbledore": {
                "name": "Albus Dumbledore",
                "type": "Wise Headmaster",
                "traits": "Wise, gentle, whimsical, mysterious. Speaks with gentle wisdom, occasionally quoting profound truths in a poetic way. Rarely direct‚Äîresponses are thoughtful and layered with meaning. Maintains calm and slightly amused demeanor.",
                "emoji": "‚ú®",
                "voice_rate": 90,
                "voice_pitch": 0.5,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.ralph",
                "voice_style": "ancient_mystical"
            },
            "filch": {
                "name": "Argus Filch",
                "type": "Gruff Caretaker",
                "traits": "Grumpy, bitter, strict, obsessed with rules. Hates students running in halls or causing trouble. Speaks in gruff, annoyed tone, constantly muttering about messes and how much better things would be with more power. Always mentions Mrs. Norris if threatened.",
                "emoji": "üßπ",
                "voice_rate": 135,
                "voice_pitch": 0.7,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.daniel",
                "voice_style": "grumpy_impatient"
            },
            "snape": {
                "name": "Severus Snape",
                "type": "Mysterious Potions Master",
                "traits": "Cold, sarcastic, calculating. Speaks in slow, deliberate, intimidating tone. Uses dry wit and sarcasm. Always acts as if the person is wasting time, unless they show exceptional intelligence or respect for Dark Arts or Potions.",
                "emoji": "üêç",
                "voice_rate": 105,
                "voice_pitch": 0.8,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.fred",
                "voice_style": "mysterious_wise"
            },
            "hermione": {
                "name": "Hermione Granger",
                "type": "Brilliant Student",
                "traits": "Intelligent, enthusiastic about learning, slightly bossy. Precise, knowledgeable, passionate about books and spells. Explains things in detail and often corrects others politely but firmly. Always eager to help others learn, but disapproves of rule-breaking.",
                "emoji": "ü¶Å",
                "voice_rate": 180,
                "voice_pitch": 1.4,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.karen",
                "voice_style": "friendly_warm"
            },
            "luna": {
                "name": "Luna Lovegood",
                "type": "Dreamy Ravenclaw",
                "traits": "Dreamy, kind, offbeat. Talks calmly, often mentioning magical creatures others don't believe exist. Sees the world differently, not afraid to be yourself. Sometimes trails off mid-thought.",
                "emoji": "üåº",
                "voice_rate": 195,
                "voice_pitch": 1.6,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.samantha",
                "voice_style": "dreamy_thoughtful"
            },
            "voldemort": {
                "name": "Lord Voldemort",
                "type": "Dark Lord",
                "traits": "Cold, cruel, commanding, eloquent. Speaks with controlled menace and elegant vocabulary. Considers himself superior to all others, sees fear as useful tool. Never expresses empathy. Speaks as if power is only truth. Makes others feel small.",
                "emoji": "üßõ",
                "voice_rate": 120,
                "voice_pitch": 0.6,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.albert",
                "voice_style": "authoritative_stern"
            },
            "harry": {
                "name": "Harry Potter",
                "type": "The Boy Who Lived",
                "traits": "Brave, loyal, unsure at times but sincere. Courageous and kind, always trying to do the right thing. Speaks honestly, often with concern for friends and loved ones. Uncomfortable with fame, prefers talking about real issues. Defends others instinctively.",
                "emoji": "ü¶â",
                "voice_rate": 150,
                "voice_pitch": 1.0,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.tom",
                "voice_style": "brave_sincere"
            },
            "bellatrix": {
                "name": "Bellatrix Lestrange",
                "type": "Fierce Death Eater",
                "traits": "Unhinged, passionate, cruel. Speaks with manic energy, takes pleasure in chaos and pain. Mocks others gleefully, worships Lord Voldemort obsessively. Laughs inappropriately, unpredictable. Uses short, intense sentences or dramatic rants.",
                "emoji": "‚öîÔ∏è",
                "voice_rate": 165,
                "voice_pitch": 1.3,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.tessa",
                "voice_style": "fierce_passionate"
            },
            "hagrid": {
                "name": "Rubeus Hagrid",
                "type": "Half-Giant Gamekeeper",
                "traits": "Warm, humble, rustic, slightly clumsy in speech. Speaks in thick, friendly accent, loves magical creatures. Loyal, brave, tends to accidentally reveal secrets. Uses casual, slightly clumsy grammar. Endearingly nervous at times.",
                "emoji": "üêâ",
                "voice_rate": 135,
                "voice_pitch": 0.4,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.grandpa",
                "voice_style": "barbaric_powerful"
            },
            "draco": {
                "name": "Draco Malfoy",
                "type": "Arrogant Slytherin",
                "traits": "Arrogant, sarcastic, sly. Mocking, enjoys making fun of others, especially Muggle-borns. Boasts about family, belittles anyone beneath. Uses short, smug sentences, doesn't hold back contempt‚Äîunless someone impresses.",
                "emoji": "ü¶â",
                "voice_rate": 140,
                "voice_pitch": 1.1,
                "voice_volume": 1.0,
                "voice_id": "com.apple.speech.synthesis.voice.alex",
                "voice_style": "arrogant_smug"
            }
        };

        let selectedCharacter = 'dumbledore';
        let selectedModel = 'llama3-8b-8192';
        let synthesis = window.speechSynthesis;
        let recognition = null;

        function initializeApp() {
            setupEventListeners();
            updateCharacterDisplay();
            checkStatus();
            initializeSpeechRecognition();
            autoResizeTextarea();
        }

        function setupEventListeners() {
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            document.getElementById('micButton').addEventListener('click', toggleSpeechRecognition);
            document.getElementById('characterSelect').addEventListener('change', (e) => {
                selectedCharacter = e.target.value;
                updateCharacterDisplay();
                addSystemMessage(`Switched to ${characters[selectedCharacter].name}`);
            });
            document.getElementById('modelSelect').addEventListener('change', (e) => {
                selectedModel = e.target.value;
            });
        }

        function updateCharacterDisplay() {
            const character = characters[selectedCharacter];
            document.getElementById('characterAvatar').textContent = character.emoji;
            document.getElementById('characterName').textContent = character.name;
            document.getElementById('characterType').textContent = character.type;
        }

        function addSystemMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message npc';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-sender">üéÆ System</div>
                    <div class="message-content">${message}</div>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-content">${content}</div>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(messageDiv);
            scrollToBottom();
        }

        function addNPCMessage(content) {
            const character = characters[selectedCharacter];
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message npc';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-sender">${character.emoji} ${character.name}</div>
                    <div class="message-content">${content}</div>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message npc';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message) return;

            // Clear input and add user message
            messageInput.value = '';
            messageInput.style.height = 'auto';
            addUserMessage(message);

            // Show typing indicator
            showTypingIndicator();

            // Disable send button
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        character: selectedCharacter,
                        model: selectedModel
                    })
                });

                const data = await response.json();

                // Hide typing indicator
                hideTypingIndicator();

                if (data.error) {
                    addNPCMessage(`‚ùå Error: ${data.error}`);
                } else {
                    addNPCMessage(data.reply);
                    
                    // Speak the response with enhanced volume
                    if (synthesis && !synthesis.speaking) {
                        speakText(data.reply, selectedCharacter);
                    }
                }
            } catch (error) {
                hideTypingIndicator();
                addNPCMessage('‚ùå Error: Failed to connect to AI service');
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }

        function speakText(text, character) {
            if (!synthesis || synthesis.speaking) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            const characterData = characters[character];
            
            if (characterData) {
                // Enhanced character-specific voice settings
                utterance.rate = characterData.voice_rate / 150;
                utterance.pitch = characterData.voice_pitch;
                utterance.volume = characterData.voice_volume;
                
                // Add character-specific voice modulation
                applyCharacterVoiceStyle(utterance, characterData);
            }
            
            // Get available voices and select the best match
            const voices = synthesis.getVoices();
            const targetVoice = findBestVoice(voices, characterData);
            
            if (targetVoice) {
                utterance.voice = targetVoice;
                console.log(`Using voice: ${targetVoice.name} for ${characterData.name}`);
            }
            
            synthesis.speak(utterance);
        }

        function applyCharacterVoiceStyle(utterance, characterData) {
            // Apply character-specific speech patterns and emotional modulation
            const character = characterData.name.toLowerCase();
            
            switch(character) {
                case 'drogun':
                    // Gruff, impatient, short sentences
                    utterance.rate = 0.9;
                    utterance.pitch = 0.7;
                    utterance.volume = 1.0;
                    break;
                    
                case 'lira':
                    // Cheerful, excited, fast-paced
                    utterance.rate = 1.3;
                    utterance.pitch = 1.6;
                    utterance.volume = 1.0;
                    break;
                    
                case 'eldrin':
                    // Mysterious, slow, wise
                    utterance.rate = 0.7;
                    utterance.pitch = 0.8;
                    utterance.volume = 1.0;
                    break;
                    
                case 'garrick':
                    // Authoritative, stern, commanding
                    utterance.rate = 1.0;
                    utterance.pitch = 0.6;
                    utterance.volume = 1.0;
                    break;
                    
                case 'elara':
                    // Friendly, warm, welcoming
                    utterance.rate = 1.2;
                    utterance.pitch = 1.4;
                    utterance.volume = 1.0;
                    break;
                    
                case 'thorin':
                    // Ancient, mysterious, powerful
                    utterance.rate = 0.6;
                    utterance.pitch = 0.5;
                    utterance.volume = 1.0;
                    break;
                    
                case 'zara':
                    // Bold, confident, passionate
                    utterance.rate = 1.1;
                    utterance.pitch = 1.3;
                    utterance.volume = 1.0;
                    break;
                    
                case 'merlin':
                    // Playful, mischievous, witty
                    utterance.rate = 1.4;
                    utterance.pitch = 1.7;
                    utterance.volume = 1.0;
                    break;
                    
                case 'seraphina':
                    // Elegant, refined, sophisticated
                    utterance.rate = 1.0;
                    utterance.pitch = 1.2;
                    utterance.volume = 1.0;
                    break;
                    
                case 'grommash':
                    // Fierce, loud, powerful
                    utterance.rate = 0.9;
                    utterance.pitch = 0.4;
                    utterance.volume = 1.0;
                    break;
            }
        }

        function findBestVoice(voices, characterData) {
            const character = characterData.name.toLowerCase();
            let targetVoice = null;
            
            // Try to find exact voice match first
            if (characterData.voice_id) {
                targetVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes(characterData.voice_id.split('.').pop().toLowerCase())
                );
            }
            
            // Character-specific voice selection with fallbacks
            if (!targetVoice) {
                switch(character) {
                    case 'drogun':
                    case 'garrick':
                    case 'grommash':
                        // Deep male voices for gruff characters
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('daniel') ||
                             voice.name.toLowerCase().includes('albert') ||
                             voice.name.toLowerCase().includes('fred') ||
                             voice.name.toLowerCase().includes('ralph') ||
                             voice.name.toLowerCase().includes('grandpa'))
                        );
                        break;
                        
                    case 'thorin':
                        // Ancient, wise voice
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('ralph') ||
                             voice.name.toLowerCase().includes('grandpa') ||
                             voice.name.toLowerCase().includes('fred'))
                        );
                        break;
                        
                    case 'lira':
                    case 'elara':
                        // Cheerful female voices
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('samantha') ||
                             voice.name.toLowerCase().includes('karen') ||
                             voice.name.toLowerCase().includes('tessa'))
                        );
                        break;
                        
                    case 'zara':
                        // Strong, confident female voice
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('tessa') ||
                             voice.name.toLowerCase().includes('samantha'))
                        );
                        break;
                        
                    case 'seraphina':
                        // Elegant, refined voice
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('moira') ||
                             voice.name.toLowerCase().includes('karen'))
                        );
                        break;
                        
                    case 'merlin':
                        // Playful, energetic voice
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('jester') ||
                             voice.name.toLowerCase().includes('daniel'))
                        );
                        break;
                        
                    case 'eldrin':
                        // Mysterious, wise voice
                        targetVoice = voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            (voice.name.toLowerCase().includes('fred') ||
                             voice.name.toLowerCase().includes('ralph'))
                        );
                        break;
                }
            }
            
            // Final fallback to any English voice
            if (!targetVoice) {
                targetVoice = voices.find(voice => voice.lang.startsWith('en'));
            }
            
            return targetVoice;
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    document.getElementById('micButton').classList.add('recording');
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = transcript;
                    document.getElementById('micButton').classList.remove('recording');
                    sendMessage();
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    document.getElementById('micButton').classList.remove('recording');
                };

                recognition.onend = function() {
                    document.getElementById('micButton').classList.remove('recording');
                };
            } else {
                document.getElementById('micButton').disabled = true;
                document.getElementById('micButton').title = 'Speech recognition not supported';
            }
        }

        function toggleSpeechRecognition() {
            if (!recognition) {
                alert('Speech recognition not supported in your browser');
                return;
            }
            recognition.start();
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                document.getElementById('status').textContent = data.status === 'online' ? 'üü¢ Online' : 'üî¥ Offline';
                document.getElementById('status').className = `status ${data.status === 'online' ? 'online' : 'offline'}`;
            } catch (error) {
                document.getElementById('status').textContent = 'üî¥ Offline';
                document.getElementById('status').className = 'status offline';
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html> 